<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>订单结算 - 芝生药局</title>
    <script>
        (function(){
            try {
                if (window.top === window) {
                    var page = location.pathname.split('/').pop() + (location.search || '') + (location.hash || '');
                    location.replace('index.html?page=' + encodeURIComponent(page));
                }
            } catch(e) {}
        })();
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
            background-color: #f8faf8;
            color: #333;
            padding-bottom: 80px;
        }

        /* 顶部导航 */
        .top-nav {
            background: white;
            padding: 12px 15px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .back-btn {
            width: 24px;
            height: 24px;
            cursor: pointer;
            margin-right: 15px;
        }

        .page-title {
            flex: 1;
            text-align: center;
            font-size: 16px;
            font-weight: 500;
        }

        /* 区块样式 */
        .section {
            background: white;
            margin-bottom: 10px;
            padding: 15px;
        }

        .section-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* 收货地址 */
        .address-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            position: relative;
        }

        .address-card.selected {
            border-color: #4a9b4e;
            background: #f8fff9;
        }

        .address-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .address-name {
            font-size: 15px;
            font-weight: 500;
        }

        .address-phone {
            color: #666;
            font-size: 14px;
        }

        .address-detail {
            color: #666;
            font-size: 13px;
            line-height: 1.5;
        }

        .change-address {
            color: #4a9b4e;
            font-size: 13px;
            text-decoration: none;
            position: absolute;
            right: 12px;
            top: 12px;
        }

        /* 配送方式 */
        .delivery-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .delivery-option {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .delivery-option:hover {
            border-color: #4a9b4e;
        }

        .delivery-option.selected {
            border-color: #4a9b4e;
            background: #f8fff9;
        }

        .radio-circle {
            width: 18px;
            height: 18px;
            border: 2px solid #ddd;
            border-radius: 50%;
            margin-right: 12px;
            position: relative;
        }

        .delivery-option.selected .radio-circle {
            border-color: #4a9b4e;
        }

        .delivery-option.selected .radio-circle::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            background: #4a9b4e;
            border-radius: 50%;
        }

        .delivery-info {
            flex: 1;
        }

        .delivery-name {
            font-size: 14px;
            margin-bottom: 4px;
        }

        .delivery-desc {
            font-size: 12px;
            color: #999;
        }

        .delivery-price {
            color: #ff5722;
            font-size: 14px;
            font-weight: 500;
        }

        .id-upload-notice {
            background: #fff3e0;
            padding: 8px 12px;
            border-radius: 4px;
            margin-top: 8px;
            font-size: 12px;
            color: #ff9800;
            display: none;
        }

        .id-upload-notice.show {
            display: block;
        }

        /* 支付方式 */
        .payment-options {
            display: flex;
            gap: 15px;
        }

        .payment-option {
            flex: 1;
            padding: 15px 10px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .payment-option:hover {
            border-color: #4a9b4e;
        }

        .payment-option.selected {
            border-color: #4a9b4e;
            background: #f8fff9;
        }

        .payment-icon {
            width: 36px;
            height: 36px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .payment-name {
            font-size: 13px;
            color: #333;
        }

        /* 商品列表 */
        .order-item {
            display: flex;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .order-item:last-child {
            border-bottom: none;
        }

        .item-image {
            width: 60px;
            height: 60px;
            background: #f0f0f0;
            border-radius: 4px;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            color: #999;
        }
        .item-image img { width: 100%; height: 100%; object-fit: cover; display: block; border-radius: 4px; }

        .item-info {
            flex: 1;
        }

        .item-name {
            font-size: 14px;
            margin-bottom: 4px;
        }

        .item-spec {
            font-size: 12px;
            color: #999;
        }

        .item-right {
            text-align: right;
        }

        .item-price {
            color: #ff5722;
            font-size: 14px;
        }

        .item-quantity {
            font-size: 12px;
            color: #999;
            margin-top: 4px;
        }

        .prescription-badge {
            display: inline-block;
            background: #ff9800;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            margin-left: 5px;
        }

        /* 费用明细 */
        .fee-detail {
            padding: 15px 0;
        }

        .fee-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .fee-label {
            color: #666;
        }

        .fee-value {
            color: #333;
        }

        .fee-total {
            border-top: 1px solid #e0e0e0;
            padding-top: 10px;
            margin-top: 10px;
        }

        .fee-total .fee-value {
            color: #ff5722;
            font-size: 18px;
            font-weight: 600;
        }

        /* 底部结算栏 */
        .checkout-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }

        .total-info {
            display: flex;
            align-items: baseline;
            gap: 5px;
        }

        .total-label {
            font-size: 14px;
            color: #666;
        }

        .total-amount {
            color: #ff5722;
            font-size: 20px;
            font-weight: 600;
        }

        .pay-btn {
            padding: 10px 35px;
            background: linear-gradient(135deg, #4a9b4e, #6ab56e);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 16px;
            cursor: pointer;
            font-weight: 500;
        }

        .pay-btn:active {
            transform: scale(0.98);
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            z-index: 3000;
            display: none;
        }

        .toast.show {
            display: block;
            animation: fadeInOut 2s ease;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            20%, 80% { opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- 顶部导航 -->
    <div class="top-nav">
        <div class="back-btn" onclick="goBack()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
        </div>
        <div class="page-title">订单结算</div>
        <div style="width: 24px;"></div>
    </div>

    <!-- 收货地址 -->
    <div class="section">
        <div class="section-title">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                <circle cx="12" cy="10" r="3"></circle>
            </svg>
            收货地址
        </div>
        <div class="address-card selected">
            <div class="address-header">
                <span class="address-name">张三</span>
                <span class="address-phone">138****8888</span>
            </div>
            <div class="address-detail">
                北京市朝阳区建国路88号SOHO现代城A座2801室
            </div>
            <a href="#" class="change-address">切换地址 ></a>
        </div>
    </div>

    <!-- 配送方式 -->
    <div class="section">
        <div class="section-title">配送方式</div>
        <div class="delivery-options">
            <div class="delivery-option selected" onclick="selectDelivery(this, 'ems', 68)">
                <div class="radio-circle"></div>
                <div class="delivery-info">
                    <div class="delivery-name">EMS国际快递</div>
                    <div class="delivery-desc">预计7-15个工作日送达</div>
                </div>
                <div class="delivery-price">¥68</div>
            </div>
            <div class="delivery-option" onclick="selectDelivery(this, 'sf', 98)">
                <div class="radio-circle"></div>
                <div class="delivery-info">
                    <div class="delivery-name">顺丰国际</div>
                    <div class="delivery-desc">预计5-10个工作日送达</div>
                </div>
                <div class="delivery-price">¥98</div>
            </div>
        </div>
        <div class="id-upload-notice" id="idNotice">
            温馨提示：顺丰国际需上传身份证用于清关
        </div>
    </div>

    <!-- 支付方式 -->
    <div class="section">
        <div class="section-title">支付方式</div>
        <div class="payment-options">
            <div class="payment-option selected" onclick="selectPayment(this, 'wechat')">
                <div class="payment-icon" style="color: #09bb07;">微</div>
                <div class="payment-name">微信支付</div>
            </div>
            <div class="payment-option" onclick="selectPayment(this, 'alipay')">
                <div class="payment-icon" style="color: #1678ff;">支</div>
                <div class="payment-name">支付宝</div>
            </div>
            <div class="payment-option" onclick="selectPayment(this, 'union')">
                <div class="payment-icon" style="color: #ff5722;">银</div>
                <div class="payment-name">银联</div>
            </div>
        </div>
    </div>

    <!-- 商品清单 -->
    <div class="section">
        <div class="section-title">商品清单</div>
        <div id="orderItems">
            <!-- 商品列表将通过JS动态生成 -->
        </div>
    </div>

    <!-- 费用明细 -->
    <div class="section">
        <div class="section-title">费用明细</div>
        <div class="fee-detail">
            <div class="fee-row">
                <span class="fee-label">商品金额</span>
                <span class="fee-value" id="subtotal">¥0</span>
            </div>
            <div class="fee-row">
                <span class="fee-label">运费</span>
                <span class="fee-value" id="shipping">¥68</span>
            </div>
            <div class="fee-row">
                <span class="fee-label">优惠</span>
                <span class="fee-value" style="color: #4a9b4e;">-¥0</span>
            </div>
            <div class="fee-row fee-total">
                <span class="fee-label">应付总额</span>
                <span class="fee-value" id="totalAmount">¥0</span>
            </div>
        </div>
    </div>

    <!-- 底部结算栏 -->
    <div class="checkout-bar">
        <div class="total-info">
            <span class="total-label">合计：</span>
            <span class="total-amount" id="bottomTotal">¥0</span>
        </div>
        <button class="pay-btn" onclick="submitOrder()">去支付</button>
    </div>

    <!-- Toast提示 -->
    <div class="toast" id="toast"></div>

    <script>
        // 全局变量
        let orderData = {
            items: [],
            deliveryMethod: 'ems',
            deliveryFee: 68,
            paymentMethod: 'wechat',
            subtotal: 0,
            total: 0,
            hasPrescription: false
        };

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 从localStorage获取订单商品
            const checkoutItems = JSON.parse(localStorage.getItem('checkoutItems') || '[]');
            orderData.items = checkoutItems;
            
            // 检查是否有处方药
            orderData.hasPrescription = checkoutItems.some(item => item.isPrescription);
            
            renderOrderItems();
            calculateTotal();
        });

        // 渲染商品列表
        function renderOrderItems() {
            const container = document.getElementById('orderItems');
            
            container.innerHTML = orderData.items.map(item => `
                <div class="order-item">
                    <div class="item-image"><img src="${getProductImage(item.id)}" alt="${item.name}"></div>
                    <div class="item-info">
                        <div class="item-name">
                            ${item.name}
                            ${item.isPrescription ? '<span class="prescription-badge">处方药</span>' : ''}
                        </div>
                        <div class="item-spec">规格信息</div>
                    </div>
                    <div class="item-right">
                        <div class="item-price">¥${item.price}</div>
                        <div class="item-quantity">x${item.quantity}</div>
                    </div>
                </div>
            `).join('');
        }

        // 获取商品图片（演示占位）
        function getProductImage(id) {
            switch (Number(id)) {
                case 3:
                case 7:
                    return 'assets/images/products/product-prescription.svg';
                case 4:
                    return 'assets/images/products/product-eye.svg';
                case 5:
                    return 'assets/images/products/product-health.svg';
                case 6:
                    return 'assets/images/products/product-device.svg';
                case 8:
                    return 'assets/images/products/product-beauty.svg';
                default:
                    return 'assets/images/products/product-otc.svg';
            }
        }

        // 计算总价
        function calculateTotal() {
            // 计算商品小计
            orderData.subtotal = orderData.items.reduce((sum, item) => {
                return sum + (item.price * item.quantity);
            }, 0);
            
            // 计算总价
            orderData.total = orderData.subtotal + orderData.deliveryFee;
            
            // 更新显示
            document.getElementById('subtotal').textContent = `¥${orderData.subtotal}`;
            document.getElementById('shipping').textContent = `¥${orderData.deliveryFee}`;
            document.getElementById('totalAmount').textContent = `¥${orderData.total}`;
            document.getElementById('bottomTotal').textContent = `¥${orderData.total}`;
        }

        // 选择配送方式
        function selectDelivery(element, method, fee) {
            // 更新选中状态
            document.querySelectorAll('.delivery-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            element.classList.add('selected');
            
            // 更新数据
            orderData.deliveryMethod = method;
            orderData.deliveryFee = fee;
            
            // 显示/隐藏身份证提示
            const idNotice = document.getElementById('idNotice');
            if (method === 'sf') {
                idNotice.classList.add('show');
            } else {
                idNotice.classList.remove('show');
            }
            
            // 重新计算总价
            calculateTotal();
        }

        // 选择支付方式
        function selectPayment(element, method) {
            // 更新选中状态
            document.querySelectorAll('.payment-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            element.classList.add('selected');
            
            // 更新数据
            orderData.paymentMethod = method;
        }

        // 提交订单
        function submitOrder() {
            // 模拟支付流程
            showToast('正在处理支付...');
            
            // 保存订单数据
            localStorage.setItem('currentOrder', JSON.stringify(orderData));
            
            // 延迟跳转
            setTimeout(() => {
                if (orderData.hasPrescription) {
                    // 有处方药，跳转到问卷页面
                    window.location.href = 'questionnaire-page.html';
                } else {
                    // 无处方药，直接跳转到订单成功页面
                    window.location.href = 'order-detail-page.html?status=success';
                }
            }, 1500);
        }

        // 返回
        function goBack() {
            window.history.back();
        }

        // 显示提示
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }
    </script>
</body>
</html>
